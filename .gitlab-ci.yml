image: docker

variables:
  GIT_SUBMODULE_STRATEGY: recursive

services:
- docker:dind

build:
  script:
  - docker build -t build .
  - docker run --rm -v "$(pwd)":/out build cp -R /opt/eaas-proxy/. /out/eaas-proxy
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  # - docker pull "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" || true
  - docker build --cache-from "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" .
  - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"
  artifacts:
    paths:
    - eaas-proxy/

pages:
  stage: deploy
  image: node
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  script:
  - npm install --unsafe-perm
  - npm run build || true
  - apt-get update && DEBIAN_FRONTEND="noninteractive" apt-get install -y default-jre
  - (cd emulator/v86; git apply ../v86-esm.patch; make)
  - rm -rf .git
  # HACK: Fix: pages:deploy - Symlink cannot be created targeting: .
  - find -maxdepth 1 -lname . -exec sh -c 'rm "$0" && mkdir "$0" && cd "$0" && ln -s ../* .' '{}' ';'
  - mkdir public
  - mv .* * public/. || true
  artifacts:
    paths:
    - public
  only:
  - master
